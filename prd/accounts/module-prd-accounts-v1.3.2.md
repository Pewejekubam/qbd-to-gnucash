# Product Requirements Document â€” accounts.py  

**Document Version:** v1.3.2
**Module Identifier:** module-prd-accounts-v1.3.2.md  
**System Context:** QuickBooks Desktop to GnuCash Conversion Tool  
**Author:** Pewe Jekubam (Development Engineer)  
**Last Updated:** 2025-06-11  
**Compatible Core PRD:** core-prd-main-v3.9.1.md  
**Governance Model:** prd-governance-model-v2.7.0.md  

---

## 1. Purpose
This module manages the conversion and validation of account data exported from QuickBooks Desktop (QBD) into an import format compatible with GnuCash CSV import. It orchestrates account mapping, hierarchy construction, and enforces typing rules critical for correct financial data import. This module's interface contracts comply with [Core PRD v3.9.1 Section 11.5: Interface Authority Precedence Rules](../core-prd-main-v3.9.1.md#115-interface-authority-precedence-rules).

## 2. Scope

### 2.1 Domain Scope
- Covers complete accounts domain processing for `!ACCNT` records as dispatched by the core dispatcher.
- Produces CSV outputs compatible with GnuCash's import formats through coordinated sub-module processing.
- Enforces strict rules on account typing, placeholder accounts, and AR/AP account special handling across domain.
- Handles pipeline HALT conditions when user input required for unmapped account types.
- Processes QBD account data exclusively within accounts domain boundaries.

### 2.2 Core Module Scope (accounts.py)
- Orchestrates account processing pipeline through mapping, tree building, validation, and export phases.
- Manages pipeline flow control and coordination between specialized sub-modules.
- Handles error propagation and HALT condition signaling to calling modules.
- Coordinates text-based mapping workflow through accounts_mapping sub-module when unmapped types detected.
- Provides single entry point interface for complete accounts domain processing.

### 2.3 Sub-Module Delegation
- **accounts_mapping.py:** Account type mapping configuration, unmapped type detection, text-based workflow processing for user interaction on mapping gaps.
- **accounts_tree.py:** Account hierarchy construction, parent-child relationship validation, type promotion rules implementation.
- **accounts_validation.py:** Final structure validation, AR/AP enforcement, circular reference detection across constructed hierarchy.
- **accounts_export.py:** GnuCash CSV file generation, format compliance validation, output integrity verification.

---

## 3. Inputs and Outputs  

### 3.1 Domain Inputs
- Dispatched payloads containing `!ACCNT` section data, as provided by the central dispatcher conforming to the `core_dispatch_payload_v1` schema.
- Mapping configuration files (`.json`) specifying account type mappings, default rules, and fallback configurations.

### 3.2 Domain Outputs
- **accounts.csv:** GnuCash-compatible CSV file (generated by accounts_export.py)
- **accounts_mapping_questions.txt:** Text-based questions file for unmapped types (generated by accounts_mapping.py when needed)
- **accounts_mapping_questions_v{number}.txt:** Generational archive files (managed by accounts_mapping.py)

### 3.3 Core Module Outputs (accounts.py)
- **Boolean return value:** Pipeline completion (True) or HALT condition (False)
- **Log entries:** Pipeline orchestration status, coordination results, error conditions
- **Sub-module coordination signals:** Success/failure states from delegated processing phases

---

## 4. Functional Requirements  

### 4.1 Domain Overview  
The accounts domain converts QBD account data into GnuCash-compatible hierarchy through specialized sub-modules coordinated by the core accounts.py orchestrator. Includes text-based workflow for user interaction when mapping gaps detected.

### 4.2 Core Module Behavior (accounts.py)
- Accept `!ACCNT` records from dispatcher and coordinate complete domain processing.
- Orchestrate mapping phase through accounts_mapping.py, handle MappingLoadError conditions and text-based workflow coordination.
- Coordinate tree construction phase through accounts_tree.py with validated mappings.
- Manage validation phase through accounts_validation.py for structure consistency.
- Control export phase through accounts_export.py for CSV generation.
- Handle pipeline HALT conditions when sub-modules indicate user action required for unmapped account types.
- Propagate errors appropriately between sub-modules and to calling modules with structured logging and clear failure state communication.

### 4.3 Sub-Module Orchestrated Behavior
- **Mapping Phase:** Load configuration through accounts_mapping.py, detect unmapped types, coordinate text-based workflow generation when needed, process completed mappings and user responses.
- **Tree Phase:** Construct account hierarchy through accounts_tree.py, apply type promotion rules, validate parent-child relationships across domain data.
- **Validation Phase:** Enforce AR/AP constraints through accounts_validation.py, detect circular references, validate structure integrity across complete hierarchy.
- **Export Phase:** Generate GnuCash CSV through accounts_export.py, validate format compliance, ensure data integrity in output files.

---

## 5. Configuration & Environment  

### 5.1 Config Schema  
- Mapping files specifying:  
  - Account type mappings (`mapping["account_types"]`)  
  - Default placeholder rules (`mapping["default_rules"]`)  
- Validation rule flags for strict AR/AP enforcement and placeholder behavior.

### 5.2 Environment Constraints  
- Python 3.8+ runtime assumed.  
- Outputs shall meet GnuCash CSV import requirements.  
- Logging shall use centralized framework exclusively as defined in [Logging Framework PRD v1.0.5](../logging/module-prd-logging-v1.0.5.md).

---

## 6. Interface & Integration  

### 6.1 Module Contract: accounts.py

- **Input:**  
  - A dispatched section payload object conforming to the `core_dispatch_payload_v1` schema as defined in [Core PRD v3.9.1 Section 11.4: Input File Discovery and Processing Model](../core-prd-main-v3.9.1.md#114-input-file-discovery-and-processing-model).

- **Output:**
  - Boolean return value indicating pipeline completion (True) or HALT condition (False)
  - Log entries documenting pipeline orchestration and status
  - Sub-module coordination results (mapping, tree, validation, export completion)

### 6.2 Interface Contracts  

#### Public Interface: `run_accounts_pipeline`
- **Arguments:**  
  - `payload: Dict[str, Any]` (conforming to `core_dispatch_payload_v1` schema; see [Core PRD v3.9.1 Section 11.4](../core-prd-main-v3.9.1.md#114-input-file-discovery-and-processing-model))  
- **Return Type:** `bool`
- **Exceptions:**  
  - `IIFParseError`  
  - `MappingLoadError`  
  - `AccountsTreeError`
- **Description:** Entry point for orchestrating QBD `!ACCNT` processing pipeline. Coordinates mapping, tree building, validation, and export phases. Returns False when HALT condition reached (user action required for unmapped accounts), True when processing completed successfully.

#### Sub-Module Interface: `generate_text_mapping_questions`
- **Arguments:**  
  - `unmapped_accounts: List[str]`, `account_records: List[Dict[str, Any]]`, `output_dir: str`
- **Return Type:** `None`
- **Exceptions:**  
  - `OutputWriteError`
- **Description:** Generate questions file with QBD path hints for unmapped accounts

**Data Structures:**
- Input: `payload` (dict) conforming to `core_dispatch_payload_v1` (see [Core PRD v3.9.1 Section 11.4](../core-prd-main-v3.9.1.md#114-input-file-discovery-and-processing-model))
- Output: Pipeline completion status and processed account data
- Mapping file structure referenced in [accounts_mapping PRD v1.0.9r1 Section 4.1](../accounts/module-prd-accounts_mapping-v1.0.9r1.md#41-config-schema)

### 6.3 Dependencies  

| Module Name           | Import Path                                                                                      | Purpose                                   
|-----------------------|--------------------------------------------------------------------------------------------------|-------------------------------------------
| `typing`              | `from typing import Dict, List, Any, Optional`                                                  | Type annotations for interface contracts |
| `accounts_export.py`  | `from modules.accounts.accounts_export import export_accounts_to_gnucash_csv`                    | GnuCash CSV file generation and format compliance    
| `accounts_mapping.py` | `from modules.accounts.accounts_mapping import load_mapping, find_unmapped_types, generate_text_mapping_questions` | Account type mapping configuration and text-based workflow coordination
| `accounts_tree.py`    | `from modules.accounts.accounts_tree import build_accounts_tree`                                 | Account hierarchy construction and parent-child validation 
| `accounts_validation.py` | `from modules.accounts.accounts_validation import run_validation_pipeline`                       | Final account structure validation and constraint enforcement
| `error_handler.py`    | `from utils.error_handler import IIFParseError, MappingLoadError, AccountsTreeError, OutputError`| Standardized exception classes            
| `logging.py`          | `from utils.logging import setup_logging`                                                        | Centralized logging configuration         

### External Requirements

- Python 3.8+ as specified in [Core PRD v3.9.1 Section 9](../core-prd-main-v3.9.1.md#9-ai-agent-compliance)  
- Conforms to logging/error handling policies as defined in [Core PRD v3.9.1 Sections 7.2, 7.3, and 7.10](../core-prd-main-v3.9.1.md#7-modular-prd-definition)  
- The mapping file structure defined here adheres to the conventions established in [Core PRD v3.9.1 Section 11.2](../core-prd-main-v3.9.1.md#112-human-validation), which requires mapping files to be in JSON format and referenced via configuration. This module's mapping schema specifically supports account type conversions while maintaining the broader architectural pattern defined in the core requirements.

---

## 7. Validation & Error Handling  

### 7.1 Validation Rules  
- Pipeline shall coordinate validation through sub-modules in sequence: mapping, tree, validation, export.
- Pipeline shall HALT gracefully when sub-modules indicate user action required for unmapped account types.
- Pipeline shall handle sub-module failures with appropriate error propagation to calling modules.
- Pipeline shall ensure all processing phases complete successfully before CSV generation.

### 7.2 Error Classes & Exit Codes
Error classes and exit codes shall be implemented per [Core PRD v3.9.1 Section 11.3.2: Error Implementation Protocol](../core-prd-main-v3.9.1.md#1132-error-implementation-protocol). All error handling shall reference the authoritative registry in [Core PRD v3.9.1 Section 14: Authoritative Error Classes & Error Code Table](../core-prd-main-v3.9.1.md#14-authoritative-error-classes--error-code-table).

---

## 8. Logging & Observability
This module complies with the centralized logging module requirements as defined in [Logging Framework PRD v1.0.5](../logging/module-prd-logging-v1.0.5.md) and [Core PRD v3.9.1 Section 7.3: Logging Strategy](../core-prd-main-v3.9.1.md#73-logging-strategy). All logging and error handling shall reference the authoritative error classes, codes, and severity levels as defined in [Core PRD v3.9.1 Section 14: Authoritative Error Classes & Error Code Table](../core-prd-main-v3.9.1.md#14-authoritative-error-classes--error-code-table). Logging shall be structured, deterministic, and flush-safe, and shall capture all error events, validation failures, and key processing steps with sufficient metadata for downstream auditing and debugging.

---

## 9. Versioning & Change Control  

### 9.1 Revision History  
| Version | Date       | Author | Summary                           
|---------|------------|--------|--------------------------------- 
| v1.0.0  | 2025-05-21 | PJ     | Initial governance-compliant PRD 
| v1.0.8  | 2025-05-21 | PJ     | Full processing through PRD template v3.5.1
| v1.0.9  | 2025-05-21 | PJ     | Full processing through PRD template v3.5.2 (which broke it!)
| v1.0.10 | 2025-05-23 | PJ     | Editorial and semantic cleanup; clarified parsing vs dispatch validation
| v1.1.1  | 2025-05-23 | PJ     | module and core PRD document naming and location restructure
| v1.1.2  | 2025-06-03 | PJ     | Added `accounts_export.py` to the "Dependencies" table (Section 6.3)
| v1.1.3  | 2025-06-03 | PJ     | Standardized Error Classes & Exit Codes and Logging & Observability sections to reference authoritative error code table and logging PRD; removed local error code/category definitions for PRD compliance.
| v1.2.0  | 2025-06-10 | PJ     | Module PRD alignment: Core PRD v3.9.1 compatibility, prd-governance-model-v2.7.0.md compliance, major interface changes with payload schema correction, interface authority compliance, dependency declarations
| v1.3.0r6| 2025-06-10 | PJ     | Granularity restructure: domain vs core module scope separation, sub-module delegation clarity, orchestration vs implementation distinction, error correction
| v1.3.0r7| 2025-06-11 | PJ     | Functional gap analysis integration: text-based workflow coordination, HALT condition handling enhancement, sub-module behavior specifications, error propagation patterns
| v1.3.0r8| 2025-06-11 | PJ     | Delegation boundary corrections: removed mapping file schema, corrected QBD field names, cleaned dependencies table for proper sub-module delegation
| v1.3.2  | 2025-06-13 | PJ     | CR-2025-CR-004v1.0.0 integration: Updated interface contracts for generate_text_mapping_questions with account_records parameter, enhanced sub-module coordination documentation

---

## 10. Example Calls for Public Functions/Classes  

```python
from modules.accounts.accounts import run_accounts_pipeline
from utils.error_handler import MappingLoadError, AccountsTreeError

# Pipeline orchestration with proper error handling
payload = {
    'section': '!ACCNT',
    'records': [
        {'NAME': 'Cash', 'ACCNTTYPE': 'BANK', 'DESC': 'Primary checking account'},
        {'NAME': 'Office Equipment', 'ACCNTTYPE': 'FIXED_ASSET', 'DESC': 'Computer equipment'}
    ],
    'output_dir': 'output/',
    'extra_config': {'strict_validation': True}
}

try:
    success = run_accounts_pipeline(payload)
    if success:
        print("Accounts processing completed successfully")
    else:
        print("Pipeline halted: User action required")
        print("Check logs for specific requirements")
except MappingLoadError as e:
    print(f"Mapping configuration error: {e}")
except AccountsTreeError as e:
    print(f"Account hierarchy error: {e}")
```

---

## 11. Appendix (Optional)  
### 11.1 Data Schemas or Additional References  
```json
{
  "account_record": {
    "NAME": "string",
    "ACCNTTYPE": "string",
    "DESC": "string|null",
    "PARENT": "string|null"
  }
}
```