# Accounts Module PRD

## 1. Version
v1.0.7

[core-prd-v3.5.0.md](../core-prd-v3.5.0.md)

## 2. Scope

**In-Scope**  
- Processing of QuickBooks Desktop (QBD) Chart of Accounts data, specifically the `!ACCNT` list type from IIF exports.  
- Validation, transformation, and mapping of QBD account records to GnuCash-compatible account formats.  
- Generation of `accounts.csv` for direct import into GnuCash.  
- Management of account type mappings, hierarchy construction, and placeholder account handling.

**Out-of-Scope**  
- Processing of other QBD data exports such as Customers, Vendors, Items, and Transactions.  
- User interface or GUI components.  
- Integration with non-accounting modules or external systems.

This module operates within the core engine framework, relying on core services for parsing, configuration, logging, and output management.

## 3. Compatibility
Compatible with: core-prd-v3.4.0.md

## 4. Use Cases

- A user runs the CLI tool against a QuickBooks Desktop `.IIF` file containing the Chart of Accounts. The tool maps account types, constructs account hierarchies, and emits a valid `accounts.csv` for GnuCash import.
- A user modifies the mapping configuration and re-runs the tool to adjust the output structure according to GnuCash's import requirements.
- A user runs the tool in verbose mode to inspect how each QuickBooks account was interpreted, including unmapped or ambiguous cases.
- A technical user integrates the accounts conversion tool into a shell script to batch-convert QBD files during scheduled system migrations.

### 5. Terminology

- **Mapping diff file**: The file `accounts_mapping_diff.json` written to `output/`, containing unmapped QBD account types for user review and correction.
- **Output file path**: The file path for the final GnuCash-compatible output, typically `output/accounts.csv`.
- **accounts.csv**: The canonical CSV output file for GnuCash import, generated by the tool.
- All references to mapping differences, output targets, and CSV paths in this document and all module PRDs must use these terms.

## 4. Module Contract: accounts.py

**Purpose:**
Orchestrates the full processing pipeline for the `!ACCNT` list type:
- Parsing → Mapping → Tree Construction → Validation → CSV Output

**Inputs:**
- `.IIF` filepath containing a `!ACCNT` section
- Mapping files:
  - `account_mapping_baseline.json` (required)
  - `accounts_mapping_specific.json` (optional override)
- Output file path (e.g., `output/accounts.csv`)

**Outputs:**
- GnuCash-compatible CSV (`accounts.csv`)
- Optional mapping diff file for unmapped types (`accounts_mapping_diff.json`)
- Logs for all key pipeline steps

**Invariants:**
- All input records must be parsed using original QBD field names (e.g., `NAME`, `ACCNTTYPE`) — case-sensitive
- Intermediate fields (e.g., `full_account_name`) must be derived explicitly and consistently
- Account records must pass validation before CSV generation
- Logging must track pipeline stages and critical error points

**Failure Modes:**
- Raises `MappingLoadError`, `AccountTreeError`, or validation exceptions on failure
- Logs structured messages for all validation issues
- Halts pipeline if critical steps fail (e.g., mapping or tree invalid)
- **Note:** The `mapping` returned by `load_and_merge_mappings()` must be unpacked before being used. Callers must extract the mapping dictionary and mapping diff file as follows:
  ```python
  mapping, diff = load_and_merge_mappings(...)
  ```

## 5. Interface Contract

### 5.1 Public Functions/Classes
- Name: run_accounts_pipeline
  - Arguments:
      - iif_path: str
      - mapping_path: str
      - csv_path: str
      - log_path: str
      - mapping_diff_path: str
  - Return type: None
  - Exceptions raised: IIFParseError, MappingLoadError, AccountTreeError
  - Description: Orchestrates the full pipeline for QBD account conversion to GnuCash CSV.
  - Example call:
    ```python
    run_accounts_pipeline(
        iif_path='input/sample-qbd-accounts.IIF',
        mapping_path='output/accounts_mapping_specific.json',
        csv_path='output/accounts.csv',
        log_path='output/qbd-to-gnucash.log',
        mapping_diff_path='output/accounts_mapping_diff.json'
    )
    ```

### 5.2 Data Structures
- Input: iif_path (str), mapping_path (str)
- Output: csv_path (str), log_path (str), mapping_diff_path (str)
- All file paths are of type `str`.
- Example mapping structure: `Dict[str, Any]` as loaded from JSON.

## 6. Data Structure Definitions (Agentic AI Compatibility)

### 6.1 Mapping File (accounts_mapping_specific.json, account_mapping_baseline.json)
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "account_types": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "gnucash_type": {"type": "string"},
          "hierarchy_path": {"type": "string"}
        },
        "required": ["gnucash_type", "hierarchy_path"]
      }
    },
    "default_rules": {
      "type": "object",
      "additionalProperties": {"type": "string"}
    }
  },
  "required": ["account_types", "default_rules"]
}
```

### 6.2 Account Record (Python Typing)
```python
from typing import TypedDict, Optional
class AccountRecord(TypedDict):
    NAME: str
    ACCNTTYPE: str
    DESC: Optional[str]
    PARENT: Optional[str]
    # ...other QBD fields as needed
```

### 6.3 Validation Error Structure (Python Typing)
```python
class ValidationError(TypedDict):
    record: dict
    error: str
    stage: str
```

## 7. Example Calls for Public Functions/Classes

### 7.1 run_accounts_pipeline
```python
# Normal case
run_accounts_pipeline(
    iif_path='input/sample-qbd-accounts.IIF',
    mapping_path='output/accounts_mapping_specific.json',
    csv_path='output/accounts.csv',
    log_path='output/qbd-to-gnucash.log',
    mapping_diff_path='output/accounts_mapping_diff.json'
)
# Edge case: missing mapping file
try:
    run_accounts_pipeline(
        iif_path='input/sample-qbd-accounts.IIF',
        mapping_path='output/missing.json',
        csv_path='output/accounts.csv',
        log_path='output/qbd-to-gnucash.log',
        mapping_diff_path='output/accounts_mapping_diff.json'
    )
except MappingLoadError as e:
    print(e)
```

## 8. Summary Table: Functions, Data Structures, Schemas, and Example Calls

| Function/Class         | Data Structure/Schema                | Example Call Location         |
|-----------------------|--------------------------------------|------------------------------|
| run_accounts_pipeline | See Interface Contract, Mapping JSON | Example Calls section         |
| Mapping Files         | Mapping Baseline/Specific (JSON Schema) | Data Structure Definitions    |
| AccountRecord         | AccountRecord (Python Typing)        | Data Structure Definitions    |
| ValidationError       | ValidationError (Python Typing)      | Data Structure Definitions    |

## 9. Assumptions

- Only the `!ACCNT` list type is handled by the accounts module.
- Account names are consistently delimited by `:` for hierarchy.
- Input files are expected to be well-formed QuickBooks exports unless otherwise noted.

### 9.1 External References & Compatibility

- Aligns with GnuCash CSV import logic and requirements.
- Ensures output matches GnuCash's expectations for commodity, namespace, and account hierarchy.

### 10. Configuration & Environment

- **Config Precedence:** If environment variables are set, they will be detected by the code and used. Otherwise, hard-coded paths will be used. This ensures that users can override defaults via environment variables, but the tool will always function with built-in fallback paths if none are set.

- **Config/Env Keys:**
  - `QBD_INPUT_PATH` (default: `input/sample-qbd-accounts.IIF`)
  - `GNC_OUTPUT_PATH` (default: `output/accounts.csv`)
  - `MAPPING_BASELINE_PATH` (default: `mappings/account_mapping_baseline.json`)
  - `MAPPING_SPECIFIC_PATH` (default: `output/accounts_mapping_specific.json`)
  - `MAPPING_DIFF_PATH` (default: `output/accounts_mapping_diff.json`)

- **Example config snippet:**
  ```python
  import os
  QBD_INPUT_PATH = os.getenv('QBD_INPUT_PATH', 'input/sample-qbd-accounts.IIF')
  GNC_OUTPUT_PATH = os.getenv('GNC_OUTPUT_PATH', 'output/accounts.csv')
  # ...

## 11. File I/O Requirements

- All IIF, JSON, and CSV file interactions must use absolute or resolved relative paths passed as arguments to `run_accounts_pipeline`.
- Input files (e.g., `.IIF`, mapping files) must be treated as **read-only**. No modifications or overwrites are permitted.
- Output files (`accounts.csv`, `accounts_mapping_diff.json`, log files) must be written to the specified output directory. If a file exists, it must be **overwritten** unless explicitly configured otherwise.
- The pipeline must **fail with a clear error** if any input file is missing or unreadable, or if the output directory is unwritable.
- File read/write operations must:
  - Use UTF-8 encoding with newline normalization (`\n`)
  - Be wrapped in try/except blocks with structured logging
  - Raise defined exceptions (e.g., `MappingLoadError`, `IIFParseError`) when failing due to file I/O


## 12. Error Handling and Logging
- This module must comply with all requirements in [Logging Framework module PRD v1.0.2](../logging/module-prd-logging-v1.0.2.md) and [core PRD section 10.12](../core-prd-v3.4.0.md#1012-logging-and-error-handling).
- Remove all module-specific logging/error handling requirements from this document; see the centralized logging module for details.

## 13. Version History

- v1.0.0 (2025-05-19): Initial release, extracted and centralized all accounts module requirements from core PRD.
- v1.0.1 (2025-05-19): Add explicit JSON Schema and Python typing for all major data structures. Add comprehensive example calls for public functions/classes, including edge cases. Reference schemas and examples in the interface contract. Add a summary table mapping functions/data structures to their schema and example call location.
- v1.0.5 (2025-05-19): Align with PRD-base v3.4.0, update interface contracts and data structure definitions for agentic AI compatibility.
- v1.0.6 (2025-05-20): Superset of v1.0.5 with new sections appended per governance model. All prior content preserved.

---

## 14. Data Mapping Flow

- Convert QBD data structures (e.g., `ACCNT` lines) into normalized internal dictionaries.
- Normalize all incoming fields to lowercase with underscores.
- Validate IIF structure and mapping status before further transformation.
- Use a registry-dispatched orchestrator to delegate per-key transformations based on configuration.
- Merge `accounts_mapping_specific.json` on top of `accounts_mapping_baseline.json`.
- Emit GnuCash-compatible `accounts.csv` output after path resolution and flattening.
- Additional modules like `customers`, `vendors`, and `transactions` are modularized and follow the same dispatch+config pipeline, but are not yet implemented in the MVP.

---

## 15. Config Merge & Diff Workflow

- On first run, only the `accounts_mapping_baseline.json` file is present.
- If unmapped types or accounts are detected, a `accounts_mapping_diff.json` file is written to `output/`, capturing problematic entries for review.
- Users must edit the `diff` file, copy relevant entries into `accounts_mapping_specific.json`, and rerun the tool.
- On each run, the system will:
  1. Load the baseline config.
  2. Merge the specific config (if present).
  3. Write a new `diff` if unresolved mappings remain.
- This process allows incremental refinement of account mappings.
- This pattern generalizes to other future modules.
> The presence of all three stages (baseline load, specific overlay, diff write) must be enforced in the pipeline with log assertions or debug-mode checkpoints.

---

## 16. Special Handling for AR/AP

GnuCash uses `RECEIVABLE` and `PAYABLE` as internal account types for its business modules.

To avoid import issues and GUI bugs:

- This tool maps:
  - QBD `AR` accounts to `ASSET`
  - QBD `AP` accounts to `LIABILITY`
- Names and hierarchy are preserved (e.g., `Assets:Accounts Receivable`).

After import:

1. Open your GnuCash file.
2. Enable business features via the *Business* menu.
3. Manually edit the `Accounts Receivable` and `Accounts Payable` accounts.
4. Set their types to `RECEIVABLE` and `PAYABLE` respectively.

---

## 17. Hierarchy Construction

This section defines the domain-specific rules for account hierarchy construction used by the accounts module, including placeholder parent insertion and flattening rules in compliance with GnuCash standards.
- GnuCash hierarchy is determined by colon-delimited account paths (e.g., `Expenses:Travel:Airfare`).
- Each account's **full path** determines its position in the hierarchy, but its `Account Name` field (used for display/reference) includes **only the final segment** (e.g., `Airfare`), not the full path.
- This separation ensures GnuCash properly resolves the account tree without duplicating path information in display names.
- Placeholder parents are inserted when intermediate levels are missing from the input.
- During flattening, placeholder accounts with only one real child are removed, and their child is promoted to preserve a clean hierarchy.
- Hierarchy integrity and naming rules are validated against GnuCash import rules ([GnuCash Guide: Accounts](https://www.gnucash.org/viewdoc.phtml?rev=5&lang=C&doc=guide)).

---

## 18. AccountValidationSuite

A **validation suite** is a set of reusable, composable methods that inspect integrity at each stage of the pipeline. These support error raising, structured logging, and optional halting.

**Structure**

```python
class AccountValidationSuite:
    def validate_iif_record(self, record: dict) -> bool: ...
    def validate_mapping(self, qb_type: str, mapping: dict) -> bool: ...
    def validate_account_tree(self, tree: dict) -> bool: ...
    def validate_flattened_tree(self, tree: dict) -> bool: ...
    def validate_csv_row(self, row: dict) -> bool: ...
    def run_all(self, records, mapping, tree, csv_rows): ...
```

**Integration Points**

- **After parsing**: validate each IIF record.
- **After mapping**: ensure every QBD type maps to a known GnuCash path.
- **After tree build**: detect missing parents, circular paths.
- **After flattening**: validate placeholder promotion and 1-child rule.
- **Before CSV write**: confirm final row integrity.

**Pipeline Usage**

```python
validator = AccountValidationSuite()

for record in records:
    validator.validate_iif_record(record)

for qb_type in qb_account_types:
    validator.validate_mapping(qb_type, combined_map)

validator.validate_account_tree(tree)
validator.validate_flattened_tree(tree)

for row in csv_rows:
    validator.validate_csv_row(row)
```

**Benefits**

- Centralizes logic for integrity enforcement
- Improves error logging and testability
- Supports automation and agent-aware validation
- Makes dry-run/test modes possible

---

### 18.1 Summary Table: Stage vs. Validator

| Stage                | Validator Method            |
|----------------------|-----------------------------|
| IIF Parsing          | `validate_iif_record`       |
| Mapping              | `validate_mapping`          |
| Tree Construction    | `validate_account_tree`     |
| Parent Existence     | `validate_account_tree`     |
| Flattening           | `validate_flattened_tree`   |
| CSV Output           | `validate_csv_row`          |

---
